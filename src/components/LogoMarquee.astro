---
import type { CollectionEntry } from 'astro:content';
import ClientCard from './ClientCard.astro';

type Client = CollectionEntry<'site'>['data']['clients'][number];

interface Props {
  clients?: Client[];
}

const { clients = [] } = Astro.props;
---

<!-- Mobile: Swipeable carousel -->
<section class="animate-fade-in-up relative md:hidden overflow-hidden" style="--delay: 260ms;">
  <div id="mobile-carousel-viewport" class="overflow-hidden px-4 pb-4">
    <div id="mobile-carousel-container" class="flex gap-4">
      {clients.map((client) => (
        <ClientCard
          name={client.name}
          description={client.description}
          logoSrc={client.logoSrc}
        />
      ))}
    </div>
  </div>

  <!-- Pagination dots -->
  <div id="mobile-carousel-dots" class="flex justify-center gap-0">
    {clients.map((_, index) => (
      <button
        type="button"
        aria-label={`Go to slide ${index + 1}`}
        class="p-1.5 cursor-pointer group"
        data-dot={index}
      >
        <span
          class:list={[
            'block size-2.5 rounded-full transition-colors group-hover:bg-white/50',
            index === 0 ? 'bg-white' : 'bg-white/20',
          ]}
        />
      </button>
    ))}
  </div>
</section>

<!-- Desktop: Bare logos with descriptions, alpha mask edges -->
<section class="hidden md:block relative overflow-hidden desktop-marquee-mask md:-mx-10 shrink-0">
  <h2 class="sr-only">Some of our Clients</h2>
  <div id="marquee-track" class="marquee-track flex items-start gap-24 py-24">
    {[0, 1].map((setIndex) => (
      <div class="marquee-content flex items-start gap-24" aria-hidden={setIndex === 1 ? "true" : undefined}>
        {clients.map((client, index) => (
          <div
            class:list={[
              'flex flex-col items-center w-[270px]',
              setIndex === 0 ? 'animate-fade-in-up' : ''
            ]}
            style={setIndex === 0 ? `--delay: ${260 + index * 60}ms` : ''}
          >
            <div class="h-20 flex items-center justify-center">
              <img
                src={client.logoSrc}
                alt={client.name}
                style={`height: ${client.logoHeight || 80}px`}
                class="w-auto max-w-full object-contain"
              />
            </div>
            <p class="mt-6 text-[14px] text-white/70 text-center tracking-[-0.14px] leading-normal">
              {client.description}
            </p>
          </div>
        ))}
      </div>
    ))}
  </div>
</section>

<style>
  .marquee-track {
    will-change: transform;
  }

  .desktop-marquee-mask {
    -webkit-mask-image: linear-gradient(to right, transparent, black 172px, black calc(100% - 172px), transparent);
    mask-image: linear-gradient(to right, transparent, black 172px, black calc(100% - 172px), transparent);
  }
</style>

<script>
  import EmblaCarousel from 'embla-carousel';

  // Mobile carousel with Embla
  const viewport = document.getElementById('mobile-carousel-viewport');
  const dotsContainer = document.getElementById('mobile-carousel-dots');
  const dots = dotsContainer?.querySelectorAll('[data-dot]');

  if (viewport && dots && dots.length > 0) {
    const embla = EmblaCarousel(viewport, {
      containScroll: 'trimSnaps',
      align: 'start',
    });

    const updateDots = () => {
      const selected = embla.selectedScrollSnap();
      dots.forEach((dot, index) => {
        const indicator = dot.querySelector('span');
        if (indicator) {
          indicator.classList.toggle('bg-white', index === selected);
          indicator.classList.toggle('bg-white/20', index !== selected);
        }
      });
    };

    embla.on('select', updateDots);

    dots.forEach((dot) => {
      dot.addEventListener('click', () => {
        const index = Number(dot.getAttribute('data-dot'));
        embla.scrollTo(index);
      });
    });
  }

  // Desktop marquee with JS-calculated animation
  const marqueeTrack = document.getElementById('marquee-track');
  const marqueeContent = marqueeTrack?.querySelector('.marquee-content');

  if (marqueeTrack && marqueeContent && window.matchMedia('(min-width: 768px)').matches) {
    const contentWidth = marqueeContent.getBoundingClientRect().width;
    const gap = 74;
    const totalWidth = contentWidth + gap;
    const duration = totalWidth / 30; // 30px per second

    // Use requestAnimationFrame for smoother animation
    let startTime: number | null = null;

    const animate = (timestamp: number) => {
      if (!startTime) startTime = timestamp;
      const elapsed = timestamp - startTime;
      const progress = (elapsed / (duration * 1000)) % 1;
      const translateX = -progress * totalWidth;

      marqueeTrack.style.transform = `translateX(${translateX}px)`;
      requestAnimationFrame(animate);
    };

    // Check for reduced motion preference
    if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      requestAnimationFrame(animate);

      // Restart animation smoothly when tab regains focus
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
          startTime = null;
        }
      });
    }
  }
</script>
